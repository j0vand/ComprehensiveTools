<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个税计算器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .bonus-table {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .bonus-table div {
            flex: 0 1 auto;
            min-width: 100px;
        }
        input[type="number"] {
            width: 60px;
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid black;
            padding: 5px;
            text-align: center;
        }
        #inputSalary {
            width: 60px;
        }
        .hidden {
            display: none;
        }
        .table-container {
            width: 100%;
            overflow: hidden;
        }
        #resultTable {
            width: 100%;
            transform-origin: top left;
        }
    </style>
</head>
<body>
<h1>个税计算器</h1>
<label for="inputSalary">基础工资:</label>
<input type="number" id="inputSalary" onchange="saveInput('inputSalary')" maxlength="5"><br><br>

<button onclick="toggleAdvancedOptions()">更多选项</button>
<div id="advancedOptions" class="hidden">
    <label for="taxDeduction">专项扣除(默认租房1500）:</label>
    <input type="number" id="taxDeduction" onchange="saveInput('taxDeduction')"><br><br>

    <label for="socialSecurityBase">社保基数(默认5000）:</label>
    <input type="number" id="socialSecurityBase" onchange="saveInput('socialSecurityBase')"><br><br>

    <label for="housingFundBase">公积金基数（默认全额）:</label>
    <input type="number" id="housingFundBase" onchange="saveInput('housingFundBase')"><br><br>

    <label for="housingFundRate">公积金比例(默认5%):</label>
    <input type="number" id="housingFundRate" onchange="saveInput('housingFundRate')"><br><br>

    <label for="annualIncome">年度总收入（可选）:</label>
    <input type="number" id="annualIncome" onchange="saveInput('annualIncome')"><br><br>
</div>

<div id="bonusTable"></div>
<button onclick="resetBonuses()">重置奖金</button><br><br>

<label for="singleBonusMonth">选择单独计税的奖金月份 (可选):</label>
<select id="singleBonusMonth" onchange="saveInput('singleBonusMonth')">
    <option value="">无</option>
</select><br><br>

<button onclick="calculate()">计算</button>
<div id="result">
    <div class="table-container">
        <div id="resultTable"></div>
    </div>
</div>

<script type="text/javascript">
    const taxBrackets = [
        {threshold: 0, upperLimit: 36000, rate: 0.03, quickDeduction: 0},
        {threshold: 36000, upperLimit: 144000, rate: 0.1, quickDeduction: 2520},
        {threshold: 144000, upperLimit: 300000, rate: 0.2, quickDeduction: 16920},
        {threshold: 300000, upperLimit: 420000, rate: 0.25, quickDeduction: 31920},
        {threshold: 420000, upperLimit: 660000, rate: 0.3, quickDeduction: 52920},
        {threshold: 660000, upperLimit: 960000, rate: 0.35, quickDeduction: 85920},
        {threshold: 960000, upperLimit: Infinity, rate: 0.45, quickDeduction: 181920}
    ];

    window.onload = function () {
        generateBonusTable();
        loadInputs(['inputSalary', 'taxDeduction', 'socialSecurityBase', 'housingFundBase', 'housingFundRate', 'singleBonusMonth', 'annualIncome']);
        updateBonusMonthOptions();
        adjustScale();
    };

    window.addEventListener('resize', adjustScale);

    function saveInput(id) {
        const value = document.getElementById(id)?.value;
        if (value !== undefined) localStorage.setItem(id, value);
    }

    function loadInputs(ids) {
        ids.forEach(id => {
            const savedValue = localStorage.getItem(id);
            if (savedValue !== null) document.getElementById(id).value = savedValue;
        });

        for (let month = 1; month <= 12; month++) {
            const bonusInput = document.getElementById(`bonusM${month}`);
            const savedBonus = localStorage.getItem(`bonusM${month}`);
            if (savedBonus !== null && bonusInput) bonusInput.value = savedBonus;
        }
    }

    function toggleAdvancedOptions() {
        document.getElementById('advancedOptions').classList.toggle('hidden');
    }

    function generateBonusTable() {
        let bonusTableHTML = '<div class="bonus-table">';
        for (let i = 1; i <= 12; i++) {
            bonusTableHTML += `
            <div>
                <label>${i}月</label>
                <input type="number" id="bonusM${i}" onchange="saveInput('bonusM${i}'); updateBonusMonthOptions();" maxlength="7">
            </div>`;
        }
        bonusTableHTML += '</div>';
        document.getElementById('bonusTable').innerHTML = bonusTableHTML;
    }

    function updateBonusMonthOptions() {
        const selectElement = document.getElementById('singleBonusMonth');
        selectElement.innerHTML = '<option value="">无</option>';

        for (let month = 1; month <= 12; month++) {
            const bonusValue = parseFloat(document.getElementById(`bonusM${month}`).value);
            if (!isNaN(bonusValue) && bonusValue > 0) {
                selectElement.add(new Option(`${month}月`, month));
            }
        }

        const savedSingleBonusMonth = localStorage.getItem('singleBonusMonth');
        if (savedSingleBonusMonth) selectElement.value = savedSingleBonusMonth;
    }

    function calculateMonthlyTax(cumulativeIncome) {
        let tax = 0;
        for (let i = taxBrackets.length - 1; i >= 0; i--) {
            if (cumulativeIncome > taxBrackets[i].threshold) {
                tax = cumulativeIncome * taxBrackets[i].rate - taxBrackets[i].quickDeduction;
                break;
            }
        }
        return tax;
    }

    function calculateCumulativeTax(cumulativeIncome) {
        let tax = 0;
        for (let i = taxBrackets.length - 1; i >= 0; i--) {
            if (cumulativeIncome > taxBrackets[i].threshold) {
                tax = cumulativeIncome * taxBrackets[i].rate - taxBrackets[i].quickDeduction;
                break;
            }
        }
        return tax;
    }

    function calculate() {
        const getValue = (id, defaultValue) => parseFloat(document.getElementById(id)?.value) || defaultValue;
        const annualIncome = getValue('annualIncome', 0);
        if (annualIncome > 0) {
            calculateAnnualTax(annualIncome);
            return;
        }

        const monthlySalary = getValue('inputSalary', 0);
        if (monthlySalary === 0) return document.getElementById('result').innerText = "请输入有效的月工资数值";

        const taxDeduction = getValue('taxDeduction', 1500);
        const socialSecurityBase = getValue('socialSecurityBase', 5000);
        const socialSecurity = socialSecurityBase * (520 / 5000);
        const housingFundBase = getValue('housingFundBase', monthlySalary);
        const housingFund = housingFundBase * getValue('housingFundRate', 5) / 100;

        const bonuses = Array.from({length: 12}, (_, i) => getValue(`bonusM${i + 1}`, 0));
        const singleBonusMonth = parseInt(document.getElementById('singleBonusMonth')?.value) || null;

        let cumulativeTaxableIncome = 0;
        let totalTax = 0;
        let totalActualIncome = 0;
        let totalPreTaxIncome = 0;
        let previousCumulativeTax = 0;

        let resultHTML = `
         <p id="totalPreTaxIncome"></p>
        <p>社保金额: ${formatNumber(socialSecurity)}</p>
        <p>公积金金额: ${formatNumber(housingFund)}（年度总和: ${formatNumber(housingFund * 12 * 2)}）</p>
        <table>
            <tr>
                <th>月份</th>
                <th>缴税部分</th>
                <th>适用税率</th>
                <th>个税</th>
                <th>累计个税</th>
                <th>实际到手</th>
                <th>累计实际到手</th>
            </tr>
    `;

        for (let month = 1; month <= 12; month++) {
            let salary = monthlySalary + (month === singleBonusMonth ? 0 : bonuses[month - 1]);
            let incomeAfterDeductions = Math.max(salary - socialSecurity - housingFund - taxDeduction - 5000, 0);

            let previousCumulativeTaxableIncome = cumulativeTaxableIncome;
            cumulativeTaxableIncome += incomeAfterDeductions;

            let currentTax = calculateMonthlyTax(cumulativeTaxableIncome);

            let currentMonthTax = currentTax - previousCumulativeTax;
            previousCumulativeTax = currentTax;

            const actualIncome = salary - socialSecurity - housingFund - currentMonthTax;
            totalTax += currentMonthTax;
            totalActualIncome += actualIncome;
            totalPreTaxIncome += salary;

            const applicableRates = getApplicableRates(previousCumulativeTaxableIncome, cumulativeTaxableIncome);

            resultHTML += `
            <tr>
                <td>${month}</td>
                <td>${formatNumber(incomeAfterDeductions)}</td>
                <td>${applicableRates}</td>
                <td>${formatNumber(currentMonthTax)}</td>
                <td>${formatNumber(totalTax)}</td>
                <td>${formatNumber(actualIncome)}</td>
                <td>${formatNumber(totalActualIncome)}</td>
            </tr>
        `;
        }

        if (singleBonusMonth && bonuses[singleBonusMonth - 1] > 0) {
            const bonusAmount = bonuses[singleBonusMonth - 1];
            const bonusTaxableIncome = bonusAmount;
            let bonusTax = 0;

            for (let i = taxBrackets.length - 1; i >= 0; i--) {
                if (bonusTaxableIncome > taxBrackets[i].threshold) {
                    bonusTax = bonusTaxableIncome * taxBrackets[i].rate - taxBrackets[i].quickDeduction;
                    break;
                }
            }

            totalTax += bonusTax;
            totalActualIncome += (bonusAmount - bonusTax);
            totalPreTaxIncome += bonusAmount;
            cumulativeTaxableIncome += bonusAmount;

            const applicableRates = getApplicableRates(0, bonusAmount);

            resultHTML += `
            <tr>
                <td colspan="7">单独计税奖金 (${singleBonusMonth}月)</td>
            </tr>
            <tr>
                <td>单独计税奖金</td>
                <td>${formatNumber(bonusAmount)}</td>
                <td>${applicableRates}</td>
                <td>${formatNumber(bonusTax)}</td>
                <td>${formatNumber(totalTax)}</td>
                <td>${formatNumber(bonusAmount - bonusTax)}</td>
                <td>${formatNumber(totalActualIncome)}</td>
            </tr>
        `;
        }

        document.getElementById('resultTable').innerHTML = resultHTML;
        document.getElementById('totalPreTaxIncome').innerText = `全年税前总收入: ${formatNumber(totalPreTaxIncome)}`;
        saveInput('singleBonusMonth');
        adjustScale();
    }

    function calculateAnnualTax(annualIncome) {
        const taxDeduction = getValue('taxDeduction', 1500) * 12;
        const socialSecurityBase = getValue('socialSecurityBase', 5000);
        const socialSecurity = socialSecurityBase * (520 / 5000) * 12;
        const housingFundBase = getValue('housingFundBase', annualIncome / 12);
        const housingFund = housingFundBase * getValue('housingFundRate', 5) / 100 * 12;

        const taxableIncome = Math.max(annualIncome - socialSecurity - housingFund - taxDeduction - 60000, 0);
        const tax = calculateCumulativeTax(taxableIncome);
        const actualIncome = annualIncome - socialSecurity - housingFund - tax;

        let resultHTML = `
            <p>全年税前总收入: ${formatNumber(annualIncome)}</p>
            <p>社保金额: ${formatNumber(socialSecurity)}</p>
            <p>公积金金额: ${formatNumber(housingFund)}（年度总和: ${formatNumber(housingFund * 2)}）</p>
            <table>
                <tr>
                    <th>应纳税所得额</th>
                    <th>适用税率</th>
                    <th>个税</th>
                    <th>实际到手</th>
                </tr>
                <tr>
                    <td>${formatNumber(taxableIncome)}</td>
                    <td>${getApplicableRates(0, taxableIncome)}</td>
                    <td>${formatNumber(tax)}</td>
                    <td>${formatNumber(actualIncome)}</td>
                </tr>
            </table>
        `;

        document.getElementById('resultTable').innerHTML = resultHTML;
        adjustScale();
    }

    function getValue(id, defaultValue) {
        return parseFloat(document.getElementById(id)?.value) || defaultValue;
    }

        function getApplicableRates(fromIncome, toIncome) {
        let ratesInfo = [];
        let remainingIncome = toIncome - fromIncome;
        let totalIncome = remainingIncome;

        for (let i = 0; i <= taxBrackets.length - 1; i++) {
            if (fromIncome >= taxBrackets[i].threshold && fromIncome < taxBrackets[i].upperLimit) {
                let taxableAtThisRate = Math.min(remainingIncome, taxBrackets[i].upperLimit - fromIncome);
                if (taxableAtThisRate == totalIncome) ratesInfo.push(`${taxBrackets[i].rate * 100}%`);
                if (taxableAtThisRate < totalIncome) ratesInfo.push(`${formatNumber(taxableAtThisRate)} : ${taxBrackets[i].rate * 100}%`);
                remainingIncome -= taxableAtThisRate;
                fromIncome += taxableAtThisRate;
            }
        }

        return ratesInfo.join('<br>');
    }

    function formatNumber(num) {
        return num % 1 === 0 ?
            num.toFixed(0) :
            parseFloat(num.toFixed(2));
    }

    function resetBonuses() {
        for (let month = 1; month <= 12; month++) {
            const bonusInput = document.getElementById(`bonusM${month}`);
            if (bonusInput) {
                bonusInput.value = '';
                localStorage.removeItem(`bonusM${month}`);
            }
        }
        updateBonusMonthOptions();
    }

    function adjustScale() {
        const resultTable = document.getElementById('resultTable');
        const container = document.querySelector('.table-container');
        
        // 重置缩放
        resultTable.style.transform = 'scale(1)';
        
        // 获取表格和容器的尺寸
        const tableWidth = resultTable.offsetWidth;
        const containerWidth = container.offsetWidth;
        
        // 计算缩放比例
        let scale = containerWidth / tableWidth;
        
        // 限制最小缩放比例，防止内容过小难以阅读
        scale = Math.max(scale, 0.5);
        
        // 应用缩放
        resultTable.style.transform = `scale(${scale})`;
        
        // 调整容器高度以适应缩放后的内容
        container.style.height = `${resultTable.offsetHeight * scale}px`;
    }
</script>
</body>
</html>
