<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#10b981">
    <title>个税计算器</title>
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --primary-light: #d1fae5;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-main: #111827;
            --text-sub: #6b7280;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --border: #e5e7eb;
            --radius: 16px;
            --radius-sm: 8px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.6;
            padding-bottom: 40px;
        }

        /* 顶部导航区 */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            padding: 20px 20px 60px; /* 底部留白给卡片重叠 */
            color: white;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
            margin-bottom: -40px; /* 让下方内容上浮 */
            position: relative;
            z-index: 0;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .header h1 {
            font-size: 22px;
            font-weight: 700;
        }

        .help-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            backdrop-filter: blur(4px);
            cursor: pointer;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 16px;
            position: relative;
            z-index: 1;
        }

        /* 卡片通用样式 */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.5);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title::before {
            content: '';
            display: block;
            width: 4px;
            height: 16px;
            background: var(--primary);
            border-radius: 2px;
        }

        /* 表单样式 */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        @media (min-width: 600px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .input-group {
            position: relative;
        }

        .label-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .input-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-main);
        }

        .input-hint-badge {
            font-size: 11px;
            color: var(--text-sub);
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-field {
            width: 100%;
            height: 44px;
            padding: 0 40px 0 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 16px; /* 防止iOS缩放 */
            background: #f9fafb;
            transition: all 0.2s;
            color: var(--text-main);
            font-weight: 500;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            background: #fff;
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        .input-field:invalid {
            border-color: var(--danger);
        }
        
        .input-field:invalid:focus {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }
        
        .input-error {
            font-size: 12px;
            color: var(--danger);
            margin-top: 4px;
            display: none;
        }
        
        .input-group.error .input-error {
            display: block;
        }
        
        .input-group.error .input-field {
            border-color: var(--danger);
        }

        .input-unit {
            position: absolute;
            right: 12px;
            color: var(--text-sub);
            font-size: 14px;
            pointer-events: none;
        }

        /* 奖金区域折叠 */
        .bonus-toggle {
            width: 100%;
            background: #fff;
            border: 1px dashed var(--border);
            padding: 12px;
            border-radius: var(--radius-sm);
            color: var(--primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .bonus-toggle:hover {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .bonus-section {
            display: none;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px dashed var(--border);
        }

        .bonus-section.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        .bonus-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        @media (min-width: 600px) {
            .bonus-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        .bonus-item label {
            display: block;
            font-size: 12px;
            color: var(--text-sub);
            margin-bottom: 4px;
            text-align: center;
        }

        .bonus-item input {
            text-align: center;
            padding: 0 4px;
            font-size: 13px;
        }

        /* 主按钮 */
        .btn-main {
            width: 100%;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            transition: transform 0.1s, box-shadow 0.2s;
            margin-top: 8px;
        }

        .btn-main:active {
            transform: scale(0.98);
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.2);
        }

        /* 结果展示区 */
        .result-section {
            display: none;
            margin-top: 24px;
        }
        
        .result-section.show {
            display: block;
        }

        /* 摘要卡片网格 */
        .summary-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: #f8fafc;
            padding: 16px;
            border-radius: var(--radius-sm);
            text-align: center;
            border: 1px solid #f1f5f9;
        }

        .summary-card.highlight {
            background: var(--primary-light);
            border-color: rgba(16, 185, 129, 0.2);
        }

        .summary-card .label {
            font-size: 12px;
            color: var(--text-sub);
            margin-bottom: 4px;
        }

        .summary-card .value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-main);
            word-break: break-all;
        }

        .summary-card.highlight .value {
            color: var(--primary-dark);
        }

        .summary-card .value.danger {
            color: var(--danger);
        }

        /* 结果表格优化 */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            white-space: nowrap;
        }

        th {
            background: #f9fafb;
            color: var(--text-sub);
            font-weight: 600;
            padding: 12px 10px;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 12px 10px;
            text-align: right;
            border-bottom: 1px solid #f3f4f6;
            color: var(--text-main);
        }

        /* 固定首列 */
        th:first-child, td:first-child {
            position: sticky;
            left: 0;
            background: inherit;
            text-align: center;
            font-weight: 500;
            border-right: 1px solid #f3f4f6;
            z-index: 2;
        }
        
        tbody tr:nth-child(even) td:first-child { background: #fafafa; }
        tbody tr:nth-child(odd) td:first-child { background: #fff; }

        .bonus-row {
            background-color: #eff6ff !important; /* Blue 50 */
        }
        .bonus-row td {
            color: #1d4ed8;
            font-weight: 500;
        }
        
        /* 跨档位样式 */
        .cross-bracket-row td {
            background-color: #fffbeb !important; /* Amber 50 */
        }
        
        .tax-details {
            font-size: 11px;
            color: var(--text-sub);
            margin-top: 4px;
        }
        
        .tax-segment {
            white-space: nowrap;
        }

        .rate-badge {
            display: inline-block;
            background: var(--warning);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* 换工作相关样式 */
        .job-change-row td {
            border-top: 2px solid var(--primary);
            position: relative;
        }
        
        .job-change-badge {
            display: inline-block;
            font-size: 10px;
            color: white;
            background: var(--primary);
            padding: 1px 4px;
            border-radius: 4px;
            margin-top: 2px;
        }

        /* 模态框 */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(2px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: flex-end; /* Mobile bottom sheet style */
        }

        .modal-overlay.show {
            display: flex;
        }

        @media (min-width: 600px) {
            .modal-overlay {
                align-items: center;
            }
            .modal {
                border-bottom-left-radius: var(--radius);
                border-bottom-right-radius: var(--radius);
                max-width: 400px;
            }
        }

        .modal {
            background: white;
            width: 100%;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 24px;
            animation: slideUp 0.3s ease-out;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
        }

        .close-icon {
            font-size: 24px;
            color: var(--text-sub);
            cursor: pointer;
            padding: 4px;
        }

        .help-item {
            margin-bottom: 16px;
        }
        .help-item dt {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-main);
        }
        .help-item dd {
            font-size: 13px;
            color: var(--text-sub);
            line-height: 1.5;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        .clear-btn {
            font-size: 13px;
            color: var(--danger);
            background: none;
            border: none;
            padding: 8px;
            width: 100%;
            margin-top: 12px;
            cursor: pointer;
        }
        
        /* Toast提示样式 */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: toastSlideUp 0.3s ease-out;
            max-width: 90%;
            text-align: center;
        }
        
        .toast.success {
            background-color: var(--primary);
        }
        
        .toast.error {
            background-color: var(--danger);
        }
        
        .toast.warning {
            background-color: var(--warning);
        }
        
        .toast.info {
            background-color: #3b82f6;
        }
        
        @keyframes toastSlideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-top">
            <a href="../../index.html" style="color: white; text-decoration: none; font-size: 14px; opacity: 0.9; display: flex; align-items: center;">
                ← 返回主页
            </a>
            <h1>个税计算器</h1>
            <button class="help-btn" id="help-btn">说明</button>
        </div>
        <p style="font-size: 13px; opacity: 0.9;">2024版 · 累计预扣预缴法</p>
    </div>

    <div class="container">
        <!-- 收入配置卡片 -->
        <div class="card">
            <h2 class="card-title">收入与扣除</h2>
            <div class="form-grid">
                <!-- 基础工资 -->
                <div class="input-group">
                    <div class="label-row">
                        <label class="input-label">基础月薪</label>
                        <span class="input-hint-badge">税前</span>
                    </div>
                    <div class="input-wrapper">
                        <input type="number" id="baseSalary" class="input-field" placeholder="0" min="0" step="0.01">
                        <span class="input-unit">元</span>
                    </div>
                    <div class="input-error">请输入有效的月薪金额</div>
                </div>

                <!-- 专项扣除 -->
                <div class="input-group">
                    <div class="label-row">
                        <label class="input-label">专项附加扣除</label>
                        <span class="input-hint-badge">每月</span>
                    </div>
                    <div class="input-wrapper">
                        <input type="number" id="specialDeduction" class="input-field" placeholder="0" value="1500" min="0" step="0.01">
                        <span class="input-unit">元</span>
                    </div>
                    <div class="input-error">请输入有效的扣除金额</div>
                </div>
            </div>
        </div>

        <!-- 社保公积金卡片 -->
        <div class="card">
            <h2 class="card-title">五险一金</h2>
            <div class="form-grid">
                <!-- 社保基数 -->
                <div class="input-group">
                    <div class="label-row">
                        <label class="input-label">社保基数</label>
                    </div>
                    <div class="input-wrapper">
                        <input type="number" id="socialBase" class="input-field" placeholder="0" value="5000">
                        <span class="input-unit">元</span>
                    </div>
                </div>

                <!-- 公积金基数 -->
                <div class="input-group">
                    <div class="label-row">
                        <label class="input-label">公积金基数</label>
                        <span class="input-hint-badge">可选</span>
                    </div>
                    <div class="input-wrapper">
                        <input type="number" id="fundBase" class="input-field" placeholder="留空则同月薪">
                        <span class="input-unit">元</span>
                    </div>
                </div>

                <!-- 公积金比例 -->
                <div class="input-group">
                    <div class="label-row">
                        <label class="input-label">公积金比例</label>
                    </div>
                    <div class="input-wrapper">
                        <input type="number" id="fundRate" class="input-field" placeholder="5-12" value="5">
                        <span class="input-unit">%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 奖金设置卡片 -->
        <div class="card">
            <div class="card-title" style="margin-bottom: 0; justify-content: space-between;">
                <span>奖金设置</span>
            </div>
            
            <div style="margin-top: 16px; display: flex; gap: 12px;">
                <button id="toggleBonusBtn" class="bonus-toggle" style="flex:1;">
                    <span id="bonusBtnText">展开奖金设置</span>
                    <span id="bonusArrow">▼</span>
                </button>
                
                <button id="toggleJobChangeBtn" class="bonus-toggle" style="flex:1;">
                    <span id="jobChangeBtnText">年度中间换工作?</span>
                    <span id="jobChangeArrow">▼</span>
                </button>
            </div>

            <!-- 换工作设置区域 -->
            <div id="jobChangeSection" class="bonus-section">
                <div class="input-group">
                    <label class="input-label" style="display:block;margin-bottom:8px;">选择入职新公司的月份</label>
                    <div class="input-wrapper">
                        <select id="jobChangeMonth" class="input-field" style="-webkit-appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2220%22%20height%3D%2220%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M5%206l5%205%205-5%22%20stroke%3D%22%23999%22%20stroke-width%3D%222%22%20fill%3D%22none%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 10px center;">
                            <option value="">无换工作</option>
                            <option value="2">2月</option>
                            <option value="3">3月</option>
                            <option value="4">4月</option>
                            <option value="5">5月</option>
                            <option value="6">6月</option>
                            <option value="7">7月</option>
                            <option value="8">8月</option>
                            <option value="9">9月</option>
                            <option value="10">10月</option>
                            <option value="11">11月</option>
                            <option value="12">12月</option>
                        </select>
                    </div>
                </div>
                
                <!-- 新公司薪资配置 -->
                <div id="newCompanyInputs" style="display:none; margin-top:16px; border-top:1px dashed var(--border); padding-top:16px;">
                    <div style="font-size:13px; font-weight:600; color:var(--primary); margin-bottom:12px;">新公司薪资待遇</div>
                    <div class="form-grid">
                        <!-- 基础工资 -->
                        <div class="input-group">
                            <label class="input-label">新月薪</label>
                            <div class="input-wrapper">
                                <input type="number" id="newBaseSalary" class="input-field" placeholder="同原月薪">
                                <span class="input-unit">元</span>
                            </div>
                        </div>

                        <!-- 社保基数 -->
                        <div class="input-group">
                            <label class="input-label">新社保基数</label>
                            <div class="input-wrapper">
                                <input type="number" id="newSocialBase" class="input-field" placeholder="同原基数">
                                <span class="input-unit">元</span>
                            </div>
                        </div>

                        <!-- 公积金基数 -->
                        <div class="input-group">
                            <label class="input-label">新公积金基数</label>
                            <div class="input-wrapper">
                                <input type="number" id="newFundBase" class="input-field" placeholder="同原基数">
                                <span class="input-unit">元</span>
                            </div>
                        </div>
                        
                        <!-- 公积金比例 -->
                        <div class="input-group">
                            <label class="input-label">新公积金比例</label>
                            <div class="input-wrapper">
                                <input type="number" id="newFundRate" class="input-field" placeholder="同原比例">
                                <span class="input-unit">%</span>
                            </div>
                        </div>
                        
                         <!-- 专项附加扣除 -->
                        <div class="input-group">
                            <label class="input-label">新专项扣除</label>
                            <div class="input-wrapper">
                                <input type="number" id="newSpecialDeduction" class="input-field" placeholder="同原扣除">
                                <span class="input-unit">元</span>
                            </div>
                        </div>
                    </div>
                    <p style="font-size:12px;color:var(--text-sub);margin-top:12px;">* 未填写的项目将默认沿用旧公司标准</p>
                </div>
            </div>

            <div id="bonusSection" class="bonus-section">
                <div class="input-group" style="margin-bottom: 16px;">
                    <label class="input-label" style="display:block;margin-bottom:8px;">年终奖单独计税月份</label>
                    <div class="input-wrapper">
                        <select id="bonusTaxMonth" class="input-field" style="-webkit-appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2220%22%20height%3D%2220%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M5%206l5%205%205-5%22%20stroke%3D%22%23999%22%20stroke-width%3D%222%22%20fill%3D%22none%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 10px center;">
                            <option value="">不使用单独计税</option>
                            <option value="1">1月</option>
                            <option value="2">2月</option>
                            <option value="3">3月</option>
                            <option value="4">4月</option>
                            <option value="5">5月</option>
                            <option value="6">6月</option>
                            <option value="7">7月</option>
                            <option value="8">8月</option>
                            <option value="9">9月</option>
                            <option value="10">10月</option>
                            <option value="11">11月</option>
                            <option value="12">12月</option>
                        </select>
                    </div>
                </div>

                <div class="bonus-grid" id="bonusInputs">
                    <!-- JS动态生成 -->
                </div>

                <button class="clear-btn" id="clear-bonuses-btn">清空所有奖金</button>
            </div>
        </div>

        <button class="btn-main" id="calculate-tax-btn">开始计算</button>

        <!-- 结果展示 -->
        <div id="resultSection" class="result-section">
            <h2 style="font-size: 18px; margin: 24px 0 12px; font-weight: 700;">计算结果</h2>
            
            <div class="summary-cards">
                <div class="summary-card highlight">
                    <div class="label">全年实际到手</div>
                    <div class="value" id="summaryActualIncome">0.00</div>
                </div>
                <div class="summary-card">
                    <div class="label">全年总纳税</div>
                    <div class="value danger" id="summaryTotalTax">0.00</div>
                </div>
                <div class="summary-card">
                    <div class="label">税前总收入</div>
                    <div class="value" id="summaryTotalIncome">0.00</div>
                </div>
                <div class="summary-card">
                    <div class="label">五险一金总扣除</div>
                    <div class="value" id="summaryInsurance">0.00</div>
                </div>
            </div>

            <div class="table-container">
                <table id="resultTable">
                    <thead>
                        <tr>
                            <th>月份</th>
                            <th>实际到手</th>
                            <th>个税</th>
                            <th>应纳税额</th>
                            <th>税率</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody">
                        <!-- 结果填充区 -->
                    </tbody>
                </table>
            </div>
            
            <p style="text-align: center; color: var(--text-sub); font-size: 12px; margin-top: 20px; padding-bottom: 20px;">
                * 结果仅供参考，实际以税务局计算为准
            </p>
        </div>
    </div>

    <!-- 帮助弹窗 -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">使用说明</div>
                <div class="close-icon" id="close-help-btn">×</div>
            </div>
            <div class="help-item">
                <dt>基础月薪</dt>
                <dd>您的每月固定税前工资。</dd>
            </div>
            <div class="help-item">
                <dt>专项附加扣除</dt>
                <dd>包括子女教育、继续教育、大病医疗、住房贷款利息、住房租金、赡养老人等扣除项总和。</dd>
            </div>
            <div class="help-item">
                <dt>年终奖单独计税</dt>
                <dd>根据国家政策，全年一次性奖金可以选择单独计算纳税，不并入当年综合所得（通常税率更低）。</dd>
            </div>
            <div class="help-item">
                <dt>计算公式</dt>
                <dd>应纳税所得额 = 累计收入 - 累计免税收入 - 累计减除费用(5000/月) - 累计专项扣除 - 累计专项附加扣除。</dd>
            </div>
        </div>
    </div>

    <script src="../../utils/storage-keys.js"></script>
    <script src="../../utils/common.js"></script>
    <script>
        /**
         * 个税计算器逻辑核心
         * 保持原逻辑不变
         */
        const TaxCalculator = {
            // 2024年个人所得税税率表（综合所得 - 年度）
            brackets: [
                { limit: 36000, rate: 0.03, deduction: 0 },
                { limit: 144000, rate: 0.1, deduction: 2520 },
                { limit: 300000, rate: 0.2, deduction: 16920 },
                { limit: 420000, rate: 0.25, deduction: 31920 },
                { limit: 660000, rate: 0.3, deduction: 52920 },
                { limit: 960000, rate: 0.35, deduction: 85920 },
                { limit: Infinity, rate: 0.45, deduction: 181920 }
            ],

            // 年终奖单独计税税率表（按月换算后的综合所得税率表）
            // 注意：这里的limit是月均金额的上限，不是年度金额
            bonusBrackets: [
                { limit: 3000, rate: 0.03, deduction: 0 },
                { limit: 12000, rate: 0.1, deduction: 210 },
                { limit: 25000, rate: 0.2, deduction: 1410 },
                { limit: 35000, rate: 0.25, deduction: 2660 },
                { limit: 55000, rate: 0.3, deduction: 4410 },
                { limit: 80000, rate: 0.35, deduction: 7160 },
                { limit: Infinity, rate: 0.45, deduction: 15160 }
            ],

            // 社保比例配置 (仅供参考，实际各地区不同)
            SOCIAL_RATE: 0.105,

            // 计算单月个税（基于累计预扣预缴法）
            calculate: function(config) {
                const results = [];
                let cumulativeIncome = 0; // 累计收入
                let cumulativeDeduction = 0; // 累计减除费用
                let cumulativeSpecial = 0; // 累计专项扣除
                let cumulativeAdditional = 0; // 累计专项附加扣除
                let cumulativeTaxPaid = 0; // 累计已缴纳税额

                // 1. 计算五险一金 (初始状态)
                // 计算社保和公积金详情 (用于汇总显示)
                let currentSocialBase = config.socialBase;
                let currentFundBase = config.fundBase || config.baseSalary;
                let currentFundRate = config.fundRate;
                let currentSpecialDeduction = config.specialDeduction;
                let currentBaseSalary = config.baseSalary;

                // 2. 遍历12个月
                let prevTaxableIncome = 0; // 上月累计应纳税所得额

                for (let month = 1; month <= 12; month++) {
                    // 换工作逻辑：如果启用了换工作且当前月是换工作月份
                    // 则重置累计值，重新开始计算，并更新参数
                    if (config.isJobChange && config.jobChangeMonth == month) {
                        cumulativeIncome = 0;
                        cumulativeDeduction = 0;
                        cumulativeSpecial = 0;
                        cumulativeAdditional = 0;
                        cumulativeTaxPaid = 0;
                        prevTaxableIncome = 0;
                        
                        // 更新为新公司参数 (如果未填写则沿用旧参数)
                        if (config.newBaseSalary) currentBaseSalary = config.newBaseSalary;
                        if (config.newSocialBase) currentSocialBase = config.newSocialBase;
                        if (config.newFundBase) currentFundBase = config.newFundBase;
                        if (config.newFundRate) currentFundRate = config.newFundRate;
                        if (config.newSpecialDeduction) currentSpecialDeduction = config.newSpecialDeduction;
                    }

                    // 计算当月五险一金
                    const socialDetail = currentSocialBase * this.SOCIAL_RATE;
                    const fundDetail = currentFundBase * (currentFundRate / 100);
                    const monthlyInsurance = socialDetail + fundDetail;

                    const isBonusTaxMonth = config.bonusTaxMonth == month;
                    
                    let currentBonus = parseFloat(config.bonuses[month] || 0);
                    let bonusForComprehensive = currentBonus; // 并入综合所得
                    let bonusForSeparate = 0; // 单独计税

                    if (isBonusTaxMonth && currentBonus > 0) {
                        bonusForSeparate = currentBonus;
                        bonusForComprehensive = 0;
                    }

                    const monthIncome = currentBaseSalary + bonusForComprehensive;
                    
                    cumulativeIncome += monthIncome;
                    cumulativeDeduction += 5000;
                    cumulativeSpecial += monthlyInsurance;
                    cumulativeAdditional += currentSpecialDeduction;

                    const taxableIncome = Math.max(0, cumulativeIncome - cumulativeDeduction - cumulativeSpecial - cumulativeAdditional);

                    // 计算跨档位详情
                    const segmentDetails = this.getSegmentDetails(prevTaxableIncome, taxableIncome);
                    
                    // 更新上月累计值，供下月使用
                    prevTaxableIncome = taxableIncome;

                    const taxTotal = this.getTax(taxableIncome);
                    const currentTax = Math.max(0, taxTotal - cumulativeTaxPaid); 
                    
                    // 修正浮点数精度问题
                    const currentTaxFixed = Number(currentTax.toFixed(2));
                    cumulativeTaxPaid += currentTaxFixed; // 使用修正后的当月税额累加

                    const actualIncome = monthIncome - monthlyInsurance - currentTaxFixed;

                    results.push({
                        month,
                        income: monthIncome,
                        insurance: monthlyInsurance,
                        socialDetail: socialDetail, // 社保部分
                        fundDetail: fundDetail,     // 公积金部分
                        taxableIncome,
                        tax: currentTaxFixed,
                        actual: Number(actualIncome.toFixed(2)), // 实际到手也保留两位
                        rate: this.getRate(taxableIncome),
                        isBonusMonth: isBonusTaxMonth,
                        bonusSeparate: bonusForSeparate,
                        segments: segmentDetails, // 纳税分段详情
                        isJobChangeMonth: config.isJobChange && config.jobChangeMonth == month // 标记换工作月份
                    });
                }
                return results;
            },

            // 计算区间内的纳税分段详情
            getSegmentDetails: function(startIncome, endIncome) {
                if (endIncome <= startIncome) return [];
                
                const segments = [];
                let currentLower = 0;

                for (const bracket of this.brackets) {
                    // 当前档位的区间 [currentLower, bracket.limit]
                    // 纳税区间的交集 [startIncome, endIncome]
                    
                    // 计算重叠部分的下限和上限
                    const overlapStart = Math.max(startIncome, currentLower);
                    const overlapEnd = Math.min(endIncome, bracket.limit);
                    
                    if (overlapEnd > overlapStart) {
                        const amount = overlapEnd - overlapStart;
                        segments.push({
                            rate: bracket.rate,
                            amount: amount,
                            tax: amount * bracket.rate
                        });
                    }
                    
                    if (bracket.limit >= endIncome) break;
                    currentLower = bracket.limit;
                }
                
                return segments;
            },

            // 计算年终奖的分段详情（用于显示各档位税额）
            // 按照分段累进方式计算，展示各档位的税额分解
            // 注意：虽然官方公式是总额×税率-速算扣除数，但这里按分段累进方式展示各档位税额
            getBonusSegmentDetails: function(bonus) {
                if (bonus <= 0) return [];
                
                const avg = bonus / 12; // 月均金额
                const segments = [];
                let currentLower = 0;
                
                // 按照月均金额的档位，将奖金总额分段计算
                // 每个档位的年度上限 = 月均上限 × 12
                for (const bracket of this.bonusBrackets) {
                    // 当前档位的月均上限
                    const monthlyUpper = bracket.limit;
                    // 当前档位的年度上限（月均上限 × 12）
                    const annualUpper = monthlyUpper * 12;
                    
                    // 计算当前档位应该计算的金额
                    const segmentStart = Math.max(currentLower, 0);
                    const segmentEnd = Math.min(annualUpper, bonus);
                    
                    if (segmentEnd > segmentStart) {
                        const segmentAmount = segmentEnd - segmentStart;
                        const segmentTax = segmentAmount * bracket.rate;
                        
                        segments.push({
                            rate: bracket.rate,
                            amount: segmentAmount,
                            tax: segmentTax
                        });
                    }
                    
                    // 如果奖金总额已经在这个档位内，停止计算
                    if (bonus <= annualUpper) break;
                    
                    currentLower = annualUpper;
                }
                
                return segments;
            },

            // 计算单独计税奖金的税额
            // 根据政策：将奖金除以12得到月均金额，查找对应税率和速算扣除数
            // 应纳税额 = 奖金总额 × 适用税率 - 速算扣除数
            calculateBonusTax: function(bonus) {
                if (bonus <= 0) return { 
                    tax: 0, 
                    actual: 0, 
                    rate: 0, 
                    avgAmount: 0,
                    bracket: null,
                    segments: []
                };
                
                // 将奖金除以12，得到月均金额
                const avg = bonus / 12;
                
                // 使用年终奖专用税率表（按月换算后的综合所得税率表）
                const bracket = this.bonusBrackets.find(b => avg <= b.limit);
                
                // 计算公式：应纳税额 = 全年一次性奖金 × 适用税率 - 速算扣除数
                const tax = bonus * bracket.rate - bracket.deduction;
                
                // 计算分段详情（用于显示各档位税额）
                const segments = this.getBonusSegmentDetails(bonus);
                
                return {
                    tax: Math.max(0, tax),
                    actual: bonus - tax,
                    rate: bracket.rate,
                    avgAmount: avg, // 月均金额
                    bracket: bracket, // 档位信息
                    segments: segments // 分段详情
                };
            },

            getTax: function(income) {
                if (income <= 0) return 0;
                const bracket = this.brackets.find(b => income <= b.limit);
                return income * bracket.rate - bracket.deduction;
            },

            getRate: function(income) {
                if (income <= 0) return 0;
                const bracket = this.brackets.find(b => income <= b.limit);
                return bracket.rate;
            }
        };

        /**
         * 应用逻辑与UI控制
         */
        const app = {
            state: {
                baseSalary: '',
                specialDeduction: 1500,
                socialBase: 5000,
                fundBase: '',
                fundRate: 5,
                bonusTaxMonth: '',
                bonuses: {},
                jobChangeMonth: '',
                // 新公司参数
                newBaseSalary: '',
                newSocialBase: '',
                newFundBase: '',
                newFundRate: '',
                newSpecialDeduction: ''
            },
            
            isBonusVisible: false,
            isJobChangeVisible: false, // 新增：控制换工作区域显示

            init: function() {
                this.loadState();
                this.renderBonusInputs();
                this.restoreUI();
                this.initEventListeners();
            },

            initEventListeners: function() {
                // 帮助按钮
                const helpBtn = document.getElementById('help-btn');
                if (helpBtn) {
                    helpBtn.addEventListener('click', () => this.showHelp());
                }

                // 关闭帮助按钮
                const closeHelpBtn = document.getElementById('close-help-btn');
                if (closeHelpBtn) {
                    closeHelpBtn.addEventListener('click', () => this.hideHelp());
                }

                // 帮助弹窗背景点击关闭
                const helpModal = document.getElementById('helpModal');
                if (helpModal) {
                    helpModal.addEventListener('click', (e) => {
                        if (e.target === helpModal) {
                            this.hideHelp();
                        }
                    });
                }

                // 切换奖金设置
                const toggleBonusBtn = document.getElementById('toggleBonusBtn');
                if (toggleBonusBtn) {
                    toggleBonusBtn.addEventListener('click', () => this.toggleBonus());
                }

                // 切换换工作设置
                const toggleJobChangeBtn = document.getElementById('toggleJobChangeBtn');
                if (toggleJobChangeBtn) {
                    toggleJobChangeBtn.addEventListener('click', () => this.toggleJobChange());
                }

                // 清空奖金按钮
                const clearBonusesBtn = document.getElementById('clear-bonuses-btn');
                if (clearBonusesBtn) {
                    clearBonusesBtn.addEventListener('click', () => this.clearBonuses());
                }

                // 计算按钮
                const calculateBtn = document.getElementById('calculate-tax-btn');
                if (calculateBtn) {
                    calculateBtn.addEventListener('click', () => this.calculate());
                }

                // 换工作月份选择器变化事件
                const jobChangeMonthSelect = document.getElementById('jobChangeMonth');
                if (jobChangeMonthSelect) {
                    jobChangeMonthSelect.addEventListener('change', () => {
                        this.toggleNewCompanyInputs();
                        this.saveState();
                    });
                }

                // 年终奖单独计税月份选择器变化事件
                const bonusTaxMonthSelect = document.getElementById('bonusTaxMonth');
                if (bonusTaxMonthSelect) {
                    bonusTaxMonthSelect.addEventListener('change', () => this.saveState());
                }

                // 新公司相关输入框变化事件
                const newCompanyInputs = ['newBaseSalary', 'newSocialBase', 'newFundBase', 'newFundRate', 'newSpecialDeduction'];
                newCompanyInputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('input', () => this.saveState());
                    }
                });

                // 基础输入框变化事件（需要保存状态和验证）
                const baseSalaryInput = document.getElementById('baseSalary');
                if (baseSalaryInput) {
                    baseSalaryInput.addEventListener('input', () => {
                        this.saveState();
                        this.validateInput('baseSalary');
                    });
                }

                const specialDeductionInput = document.getElementById('specialDeduction');
                if (specialDeductionInput) {
                    specialDeductionInput.addEventListener('input', () => {
                        this.saveState();
                        this.validateInput('specialDeduction');
                    });
                }

                // 其他基础输入框变化事件
                const basicInputs = ['socialBase', 'fundBase', 'fundRate'];
                basicInputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('input', () => this.saveState());
                    }
                });

                // 奖金输入框变化事件（动态生成，使用事件委托）
                const bonusInputsContainer = document.getElementById('bonusInputs');
                if (bonusInputsContainer) {
                    bonusInputsContainer.addEventListener('input', (e) => {
                        if (e.target && e.target.id && e.target.id.startsWith('bonus_m')) {
                            this.saveState();
                        }
                    });
                }
            },

            saveState: function() {
                const getVal = (id) => {
                    const el = document.getElementById(id);
                    return el ? el.value : '';
                };

                this.state.baseSalary = Number(getVal('baseSalary'));
                this.state.specialDeduction = Number(getVal('specialDeduction'));
                this.state.socialBase = Number(getVal('socialBase'));
                this.state.fundBase = Number(getVal('fundBase')) || '';
                this.state.fundRate = Number(getVal('fundRate'));
                this.state.bonusTaxMonth = getVal('bonusTaxMonth');
                this.state.jobChangeMonth = getVal('jobChangeMonth');
                
                // 保存新公司参数
                this.state.newBaseSalary = Number(getVal('newBaseSalary')) || '';
                this.state.newSocialBase = Number(getVal('newSocialBase')) || '';
                this.state.newFundBase = Number(getVal('newFundBase')) || '';
                this.state.newFundRate = Number(getVal('newFundRate')) || '';
                this.state.newSpecialDeduction = Number(getVal('newSpecialDeduction')) || '';

                for(let i=1; i<=12; i++) {
                    const val = getVal(`bonus_m${i}`);
                    this.state.bonuses[i] = val ? Number(val) : 0;
                }

                // 使用统一的存储键名和函数
                const STORAGE_KEY = (window.StorageKeys && window.StorageKeys.TAX_CALCULATOR_DATA) || 'tax_calculator_state';
                if (window.CommonUtils && window.CommonUtils.setLocalStorageItem) {
                    window.CommonUtils.setLocalStorageItem(STORAGE_KEY, this.state);
                } else {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(this.state));
                }
            },

            loadState: function() {
                // 使用统一的存储键名和函数
                const STORAGE_KEY = (window.StorageKeys && window.StorageKeys.TAX_CALCULATOR_DATA) || 'tax_calculator_state';
                let parsed = null;
                
                if (window.CommonUtils && window.CommonUtils.getLocalStorageItem) {
                    // 公共工具库已经返回解析后的对象，直接使用
                    parsed = window.CommonUtils.getLocalStorageItem(STORAGE_KEY, null);
                } else {
                    // 降级处理：使用原生 localStorage
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) {
                        try {
                            parsed = JSON.parse(saved);
                        } catch (e) {
                            console.error('Failed to parse saved state', e);
                        }
                    }
                }
                
                if (parsed) {
                    this.state = { ...this.state, ...parsed };
                }
            },

            restoreUI: function() {
                const setVal = (id, val) => {
                    const el = document.getElementById(id);
                    if(el) el.value = val;
                };

                setVal('baseSalary', this.state.baseSalary || '');
                setVal('specialDeduction', this.state.specialDeduction);
                setVal('socialBase', this.state.socialBase);
                setVal('fundBase', this.state.fundBase);
                setVal('fundRate', this.state.fundRate);
                setVal('bonusTaxMonth', this.state.bonusTaxMonth);
                setVal('jobChangeMonth', this.state.jobChangeMonth); 
                
                // 恢复新公司参数
                setVal('newBaseSalary', this.state.newBaseSalary);
                setVal('newSocialBase', this.state.newSocialBase);
                setVal('newFundBase', this.state.newFundBase);
                setVal('newFundRate', this.state.newFundRate);
                setVal('newSpecialDeduction', this.state.newSpecialDeduction);
                
                for(let i=1; i<=12; i++) {
                    if(this.state.bonuses[i]) {
                        setVal(`bonus_m${i}`, this.state.bonuses[i]);
                    }
                }

                const hasBonus = Object.values(this.state.bonuses).some(v => v > 0);
                if (hasBonus) {
                    this.isBonusVisible = true;
                    this.updateBonusUI();
                }

                if (this.state.jobChangeMonth) {
                    this.isJobChangeVisible = true;
                    this.updateJobChangeUI();
                    this.toggleNewCompanyInputs(); // 确保新公司输入框显示状态正确
                }
            },

            renderBonusInputs: function() {
                const container = document.getElementById('bonusInputs');
                let html = '';
                for (let i = 1; i <= 12; i++) {
                    html += `
                        <div class="bonus-item">
                            <label>${i}月</label>
                            <input type="number" id="bonus_m${i}" class="input-field" placeholder="0">
                        </div>
                    `;
                }
                container.innerHTML = html;
            },

            toggleBonus: function() {
                this.isBonusVisible = !this.isBonusVisible;
                this.updateBonusUI();
            },
            
            toggleJobChange: function() {
                this.isJobChangeVisible = !this.isJobChangeVisible;
                this.updateJobChangeUI();
            },

            updateBonusUI: function() {
                const section = document.getElementById('bonusSection');
                const btnText = document.getElementById('bonusBtnText');
                const arrow = document.getElementById('bonusArrow');

                if (this.isBonusVisible) {
                    section.classList.add('show');
                    btnText.textContent = '收起奖金设置';
                    arrow.style.transform = 'rotate(180deg)';
                } else {
                    section.classList.remove('show');
                    btnText.textContent = '展开奖金设置';
                    arrow.style.transform = 'rotate(0deg)';
                }
            },

            updateJobChangeUI: function() {
                const section = document.getElementById('jobChangeSection');
                const btnText = document.getElementById('jobChangeBtnText');
                const arrow = document.getElementById('jobChangeArrow');

                if (this.isJobChangeVisible) {
                    section.classList.add('show');
                    btnText.textContent = '收起换工作设置';
                    arrow.style.transform = 'rotate(180deg)';
                } else {
                    section.classList.remove('show');
                    btnText.textContent = '年度中间换工作?';
                    arrow.style.transform = 'rotate(0deg)';
                }
            },

            toggleNewCompanyInputs: function() {
                const month = document.getElementById('jobChangeMonth').value;
                const inputs = document.getElementById('newCompanyInputs');
                this.saveState();
                
                if (month) {
                    inputs.style.display = 'block';
                    // 自动滚动到底部
                    setTimeout(() => {
                       inputs.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 100);
                } else {
                    inputs.style.display = 'none';
                }
            },

            clearBonuses: function() {
                for(let i=1; i<=12; i++) {
                    const el = document.getElementById(`bonus_m${i}`);
                    if(el) el.value = '';
                    this.state.bonuses[i] = 0;
                }
                const elMonth = document.getElementById('bonusTaxMonth');
                if(elMonth) elMonth.value = '';
                this.state.bonusTaxMonth = '';
                this.saveState();
            },

            calculate: function() {
                if (!this.state.baseSalary && this.state.baseSalary !== 0) {
                    this.showToast('请输入基础月薪', 'error');
                    document.getElementById('baseSalary').focus();
                    return;
                }

                const config = {
                    baseSalary: Number(this.state.baseSalary),
                    specialDeduction: Number(this.state.specialDeduction),
                    socialBase: Number(this.state.socialBase),
                    fundBase: Number(this.state.fundBase) || Number(this.state.baseSalary),
                    fundRate: Number(this.state.fundRate),
                    bonusTaxMonth: this.state.bonusTaxMonth,
                    bonuses: this.state.bonuses,
                    isJobChange: !!this.state.jobChangeMonth,
                    jobChangeMonth: this.state.jobChangeMonth,
                    // 新公司配置
                    newBaseSalary: Number(this.state.newBaseSalary),
                    newSocialBase: Number(this.state.newSocialBase),
                    newFundBase: Number(this.state.newFundBase),
                    newFundRate: Number(this.state.newFundRate),
                    newSpecialDeduction: Number(this.state.newSpecialDeduction)
                };

                const monthlyResults = TaxCalculator.calculate(config);
                
                let totalIncome = 0;
                let totalTax = 0;
                let totalActual = 0;
                let totalInsurance = 0;
                let totalSocial = 0; // 社保总计
                let totalFund = 0;   // 公积金总计

                let tableHtml = '';

                monthlyResults.forEach(res => {
                    totalIncome += Number(res.income.toFixed(2));
                    totalTax += Number(res.tax.toFixed(2));
                    totalActual += Number(res.actual.toFixed(2));
                    totalInsurance += Number(res.insurance.toFixed(2));
                    totalSocial += Number(res.socialDetail.toFixed(2));
                    totalFund += Number(res.fundDetail.toFixed(2));

                    // 判断是否跨档位
                    const isCrossBracket = res.segments && res.segments.length > 1;
                    let rowClass = isCrossBracket ? 'cross-bracket-row' : '';
                    if (res.isJobChangeMonth) rowClass += ' job-change-row'; // 标记换工作行
                    
                    // 构建税率显示
                    let rateDisplay = '';
                    let taxDetailDisplay = '';
                    
                    if (isCrossBracket) {
                        // 跨档位显示
                        const rates = res.segments.map(s => (s.rate * 100).toFixed(0) + '%');
                        rateDisplay = `<span class="rate-badge">${rates.join(' ➔ ')}</span>`;
                        
                        const details = res.segments.map(s => 
                            `<div class="tax-segment">${(s.rate*100).toFixed(0)}%档: ¥${this.formatMoney(s.tax)}</div>`
                        ).join('');
                        
                        taxDetailDisplay = `
                            <div>${this.formatMoney(res.tax)}</div>
                            <div class="tax-details">${details}</div>
                        `;
                    } else {
                        // 普通显示
                        rateDisplay = (res.rate * 100).toFixed(0) + '%';
                        taxDetailDisplay = this.formatMoney(res.tax);
                    }
                    
                    // 换工作提示
                    let monthLabel = `${res.month}月`;
                    if (res.isJobChangeMonth) {
                        monthLabel += `<div class="job-change-badge">新入职</div>`;
                    }

                    tableHtml += `
                        <tr class="${rowClass}">
                            <td>${monthLabel}</td>
                            <td style="font-weight:600;color:var(--primary-dark)">${this.formatMoney(res.actual)}</td>
                            <td>${taxDetailDisplay}</td>
                            <td>${this.formatMoney(res.taxableIncome)}</td>
                            <td>${rateDisplay}</td>
                        </tr>
                    `;

                    if (res.bonusSeparate > 0) {
                        const bonusRes = TaxCalculator.calculateBonusTax(res.bonusSeparate);
                        totalIncome += res.bonusSeparate;
                        totalTax += bonusRes.tax;
                        totalActual += bonusRes.actual;

                        // 构建年终奖档位详情显示（格式与月度跨档位显示保持一致）
                        let bonusTaxDetailDisplay = '';
                        let bonusRateDisplay = '';
                        let bonusRowClass = 'bonus-row';
                        let isBonusCrossBracket = false;
                        
                        if (bonusRes.bracket && bonusRes.segments && bonusRes.segments.length > 0) {
                            const bracketInfo = bonusRes.bracket;
                            const segments = bonusRes.segments;
                            
                            // 判断是否跨档位（有多个分段）
                            isBonusCrossBracket = segments.length > 1;
                            
                            // 构建详细的计算过程说明
                            const ratePercent = (bonusRes.rate * 100).toFixed(0);
                            const bracketIndex = TaxCalculator.bonusBrackets.findIndex(b => b === bracketInfo);
                            const prevLimit = bracketIndex > 0 
                                ? TaxCalculator.bonusBrackets[bracketIndex - 1].limit 
                                : 0;
                            
                            // 构建档位范围显示
                            let bracketRange = '';
                            if (prevLimit > 0) {
                                bracketRange = `¥${this.formatMoney(prevLimit)}-`;
                            }
                            if (bracketInfo.limit === Infinity) {
                                bracketRange += '∞';
                            } else {
                                bracketRange += `¥${this.formatMoney(bracketInfo.limit)}`;
                            }
                            
                            // 计算过程说明
                            let calculationSteps = `
                                <div class="tax-segment" style="color:var(--primary-dark);font-weight:600;">步骤1: 计算月均金额</div>
                                <div class="tax-segment">月均 = ¥${this.formatMoney(res.bonusSeparate)} ÷ 12 = ¥${this.formatMoney(bonusRes.avgAmount)}</div>
                                <div class="tax-segment" style="color:var(--primary-dark);font-weight:600;margin-top:6px;">步骤2: 查找税率和速算扣除数</div>
                                <div class="tax-segment">月均¥${this.formatMoney(bonusRes.avgAmount)}落在${bracketRange}档位</div>
                                <div class="tax-segment">适用税率: ${ratePercent}%，速算扣除数: ¥${this.formatMoney(bracketInfo.deduction)}</div>
                                <div class="tax-segment" style="color:var(--primary-dark);font-weight:600;margin-top:6px;">步骤3: 计算各档位税额</div>
                            `;
                            
                            if (isBonusCrossBracket) {
                                // 跨档位显示：显示各个档位的税额
                                bonusRowClass += ' cross-bracket-row';
                                const rates = segments.map(s => (s.rate * 100).toFixed(0) + '%');
                                bonusRateDisplay = `<span class="rate-badge">${rates.join(' ➔ ')}</span>`;
                                
                                const details = segments.map(s => 
                                    `<div class="tax-segment">${(s.rate*100).toFixed(0)}%档(¥${this.formatMoney(s.amount)}): ¥${this.formatMoney(s.tax)}</div>`
                                ).join('');
                                
                                // 计算总额验证
                                const totalSegmentTax = segments.reduce((sum, s) => sum + s.tax, 0);
                                const verification = Math.abs(totalSegmentTax - bonusRes.tax) < 0.01 
                                    ? '' 
                                    : `<div class="tax-segment" style="color:var(--text-sub);font-size:10px;">* 分段合计: ¥${this.formatMoney(totalSegmentTax)}，速算公式: ¥${this.formatMoney(bonusRes.tax)}</div>`;
                                
                                bonusTaxDetailDisplay = `
                                    <div>${this.formatMoney(bonusRes.tax)}</div>
                                    <div class="tax-details">
                                        ${calculationSteps}
                                        ${details}
                                        <div class="tax-segment" style="color:var(--primary-dark);font-weight:600;margin-top:6px;">合计税额: ¥${this.formatMoney(bonusRes.tax)}</div>
                                        ${verification}
                                    </div>
                                `;
                            } else {
                                // 单档位显示
                                bonusRateDisplay = `<span class="rate-badge">${ratePercent}%</span>`;
                                
                                bonusTaxDetailDisplay = `
                                    <div>${this.formatMoney(bonusRes.tax)}</div>
                                    <div class="tax-details">
                                        ${calculationSteps}
                                        <div class="tax-segment">${ratePercent}%档: ¥${this.formatMoney(bonusRes.tax)}</div>
                                        <div class="tax-segment" style="color:var(--text-sub);font-size:10px;">计算: ¥${this.formatMoney(res.bonusSeparate)} × ${ratePercent}% - ¥${this.formatMoney(bracketInfo.deduction)} = ¥${this.formatMoney(bonusRes.tax)}</div>
                                    </div>
                                `;
                            }
                        } else {
                            bonusRateDisplay = (bonusRes.rate * 100).toFixed(0) + '%';
                            bonusTaxDetailDisplay = this.formatMoney(bonusRes.tax);
                        }

                        tableHtml += `
                            <tr class="${bonusRowClass}">
                                <td>年终奖</td>
                                <td style="font-weight:600">${this.formatMoney(bonusRes.actual)}</td>
                                <td>${bonusTaxDetailDisplay}</td>
                                <td>${this.formatMoney(res.bonusSeparate)}</td>
                                <td>${bonusRateDisplay}</td>
                            </tr>
                        `;
                    }
                });

                document.getElementById('summaryTotalIncome').textContent = this.formatMoney(totalIncome);
                document.getElementById('summaryTotalTax').textContent = this.formatMoney(totalTax);
                document.getElementById('summaryActualIncome').textContent = this.formatMoney(totalActual);
                
                // 更新五险一金汇总详情
                document.getElementById('summaryInsurance').innerHTML = `
                    <div>${this.formatMoney(totalInsurance)}</div>
                    <div style="font-size:11px;color:var(--text-sub);margin-top:2px;">
                        (社保 ${this.formatMoney(totalSocial)} + 公积金 ${this.formatMoney(totalFund)})
                    </div>
                `;
                
                document.getElementById('resultBody').innerHTML = tableHtml;
                
                const resultSection = document.getElementById('resultSection');
                resultSection.classList.add('show');
                
                // 平滑滚动到结果区域
                setTimeout(() => {
                    resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            },

            formatMoney: function(num) {
                // 如果是整数（小数部分为0），则不显示小数
                if (Number.isInteger(num)) {
                    return num.toLocaleString('zh-CN');
                }
                // 否则保留两位小数
                return num.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            },

            showHelp: function() {
                document.getElementById('helpModal').classList.add('show');
            },
            
            hideHelp: function() {
                document.getElementById('helpModal').classList.remove('show');
            },
            
            showToast: function(message, type = 'info') {
                // 移除已存在的toast
                const existingToast = document.querySelector('.toast');
                if (existingToast) {
                    existingToast.remove();
                }
                
                // 创建新的toast
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                // 3秒后自动移除
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(-50%) translateY(20px)';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, 3000);
            },
            
            validateInput: function(inputId) {
                const input = document.getElementById(inputId);
                const inputGroup = input.closest('.input-group');
                const value = parseFloat(input.value);
                
                if (input.value && (isNaN(value) || value < 0)) {
                    inputGroup.classList.add('error');
                    return false;
                } else {
                    inputGroup.classList.remove('error');
                    return true;
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>