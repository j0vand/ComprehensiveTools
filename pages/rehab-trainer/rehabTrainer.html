<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>è…°çªåº·å¤è®­ç»ƒ</title>
    
    <!-- è®¾ç½®åŸºç¡€è·¯å¾„ï¼Œç¡®ä¿ç›¸å¯¹è·¯å¾„æ­£ç¡®è§£æ -->
    <script>
        (function() {
            // è·å–å½“å‰HTMLæ–‡ä»¶çš„ç›®å½•è·¯å¾„
            var currentScript = document.currentScript;
            var basePath = '';
            
            // æ–¹æ³•1: ä»location.pathnameè·å–
            if (window.location.pathname) {
                var pathParts = window.location.pathname.split('/');
                pathParts.pop(); // ç§»é™¤æ–‡ä»¶å
                basePath = pathParts.join('/') + '/';
            }
            
            // æ–¹æ³•2: å¦‚æœæ–¹æ³•1å¤±è´¥ï¼Œå°è¯•ä»document.URLè·å–
            if (!basePath || basePath === '/') {
                try {
                    var url = new URL(window.location.href);
                    var pathname = url.pathname;
                    var lastSlash = pathname.lastIndexOf('/');
                    if (lastSlash !== -1) {
                        basePath = pathname.substring(0, lastSlash + 1);
                    }
                } catch(e) {
                    // file://åè®®å¯èƒ½ä¸æ”¯æŒURLå¯¹è±¡
                    var href = window.location.href;
                    var lastSlash = href.lastIndexOf('/');
                    if (lastSlash !== -1) {
                        basePath = href.substring(0, lastSlash + 1);
                    }
                }
            }
            
            // åˆ›å»ºbaseæ ‡ç­¾
            var baseTag = document.createElement('base');
            baseTag.href = basePath || './';
            document.head.insertBefore(baseTag, document.head.firstChild);
            
            console.log('[è·¯å¾„ä¿®å¤] åŸºç¡€è·¯å¾„è®¾ç½®ä¸º:', baseTag.href);
            console.log('[è·¯å¾„ä¿®å¤] å½“å‰é¡µé¢URL:', window.location.href);
            console.log('[è·¯å¾„ä¿®å¤] å½“å‰é¡µé¢è·¯å¾„:', window.location.pathname);
        })();
    </script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/cards.css">
    <link rel="stylesheet" href="css/modal.css">
</head>
<body>
    <!-- å¦‚æœJavaScriptè¢«ç¦ç”¨ï¼Œæ˜¾ç¤ºæç¤º -->
    <noscript>
        <div style="position: fixed; top: 0; left: 0; right: 0; background: #dc3545; color: white; padding: 20px; text-align: center; z-index: 99999; font-size: 16px;">
            âš ï¸ æ­¤åº”ç”¨éœ€è¦JavaScriptæ‰èƒ½è¿è¡Œï¼<br>
            è¯·å¯ç”¨æµè§ˆå™¨çš„JavaScriptåŠŸèƒ½ã€‚
        </div>
    </noscript>
    
    <!-- ä¸»ç•Œé¢ -->
    <div id="mainView" class="container py-4">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="mb-4">
            <h1 class="text-center mb-3">
                <i class="bi bi-heart-pulse text-danger"></i>
                è…°çªåº·å¤è®­ç»ƒ
            </h1>
        </header>

        <!-- è®¡åˆ’é€‰æ‹©åŒº -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center mb-3">
                    <div class="col-8">
                        <label for="planSelect" class="form-label mb-2">å½“å‰è®¡åˆ’</label>
                        <select id="planSelect" class="form-select">
                            <option value="">è¯·é€‰æ‹©è®­ç»ƒè®¡åˆ’</option>
                        </select>
                    </div>
                    <div class="col-4 text-end">
                        <button id="newPlanBtn" class="btn btn-outline-primary btn-sm mt-4">
                            <i class="bi bi-plus-circle"></i> æ–°å»ºè®¡åˆ’
                        </button>
                    </div>
                </div>
                <div class="row g-2">
                    <div class="col-6">
                        <button id="exportBtn" class="btn btn-outline-success btn-sm w-100">
                            <i class="bi bi-download"></i> å¯¼å‡ºæ•°æ®
                        </button>
                    </div>
                    <div class="col-6">
                        <button id="importBtn" class="btn btn-outline-info btn-sm w-100">
                            <i class="bi bi-upload"></i> å¯¼å…¥æ•°æ®
                        </button>
                        <input type="file" id="importFile" accept=".json" style="display: none;">
                    </div>
                </div>
            </div>
        </div>

        <!-- è®­ç»ƒé¡¹åˆ—è¡¨ -->
        <div id="exerciseList" class="mb-4">
            <!-- åŠ¨æ€ç”Ÿæˆè®­ç»ƒé¡¹å¡ç‰‡ -->
        </div>

        <!-- ç©ºçŠ¶æ€æç¤º -->
        <div id="emptyState" class="text-center py-5" style="display: none;">
            <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
            <p class="text-muted mt-3">è¿˜æ²¡æœ‰è®­ç»ƒé¡¹ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </p>
        </div>

        <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
        <div class="fixed-bottom-actions">
            <div class="container">
                <div class="row g-2">
                    <div class="col-6">
                        <button id="addExerciseBtn" class="btn btn-outline-primary w-100">
                            <i class="bi bi-plus-lg"></i> æ·»åŠ è®­ç»ƒé¡¹
                        </button>
                    </div>
                    <div class="col-6">
                        <button id="startTrainingBtn" class="btn btn-success w-100" disabled>
                            <i class="bi bi-play-fill"></i> å¼€å§‹è®­ç»ƒ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è®­ç»ƒæ‰§è¡Œç•Œé¢ -->
    <div id="trainingView" class="container-fluid vh-100 d-flex flex-column" style="display: none;">
        <!-- é¡¶éƒ¨è¿›åº¦ä¿¡æ¯ -->
        <div class="training-header text-center py-3">
            <h2 id="exerciseName" class="mb-2">å¹³æ¿æ”¯æ’‘</h2>
            <div class="text-muted">
                <span id="exerciseProgress">ç¬¬1ä¸ª/å…±5ä¸ª</span>
                <span class="mx-2">|</span>
                <span id="setProgress">ç¬¬1ç»„/å…±3ç»„</span>
            </div>
        </div>

        <!-- ä¸­å¤®æ˜¾ç¤ºåŒº -->
        <div class="training-main flex-grow-1 d-flex flex-column align-items-center justify-content-center">
            <!-- æŒç»­æ—¶é—´å‹æ˜¾ç¤º -->
            <div id="durationDisplay" style="display: none;">
                <div class="timer-circle mb-3 position-relative">
                    <svg class="progress-ring" width="280" height="280">
                        <circle class="progress-ring-bg" cx="140" cy="140" r="120" />
                        <circle id="progressCircle" class="progress-ring-circle" cx="140" cy="140" r="120" />
                    </svg>
                    <div class="timer-text position-absolute top-50 start-50 translate-middle">
                        <div id="timerDisplay" class="timer-number">30</div>
                        <div class="timer-unit">ç§’</div>
                    </div>
                </div>
                <div id="statusText" class="status-text text-center">å‡†å¤‡ä¸­</div>
            </div>

            <!-- æ¬¡æ•°å‹æ˜¾ç¤º -->
            <div id="repsDisplay" style="display: none;">
                <div class="reps-container text-center">
                    <div id="repsNumber" class="reps-number">10</div>
                    <div class="reps-unit">æ¬¡</div>
                    <div id="repsStatus" class="reps-status mt-3">è¯·æŒ‰è‡ªå·±çš„èŠ‚å¥å®Œæˆ</div>
                </div>
            </div>
        </div>

        <!-- åŠ¨ä½œè¯´æ˜ -->
        <div class="exercise-description text-center px-4 py-3">
            <p id="exerciseDescription" class="text-muted mb-0">ä¿æŒèº«ä½“æˆä¸€æ¡ç›´çº¿ï¼Œæ”¶ç´§æ ¸å¿ƒ</p>
        </div>

        <!-- åº•éƒ¨æ§åˆ¶æŒ‰é’® -->
        <div class="training-controls pb-4">
            <div class="container">
                <!-- æŒç»­æ—¶é—´å‹æŒ‰é’® -->
                <div id="durationControls" style="display: none;">
                    <div class="d-grid gap-2">
                        <button id="pauseBtn" class="btn btn-warning btn-lg">
                            <i class="bi bi-pause-fill"></i> æš‚åœ
                        </button>
                        <div class="row g-2">
                            <div class="col-6">
                                <button id="skipBtn" class="btn btn-outline-secondary w-100">
                                    <i class="bi bi-skip-forward"></i> è·³è¿‡
                                </button>
                            </div>
                            <div class="col-6">
                                <button id="stopBtn" class="btn btn-outline-danger w-100">
                                    <i class="bi bi-stop-fill"></i> ç»“æŸ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ¬¡æ•°å‹æŒ‰é’® -->
                <div id="repsControls" style="display: none;">
                    <div class="d-grid gap-2">
                        <button id="completeSetBtn" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle-fill"></i> å®Œæˆä¸€ç»„
                        </button>
                        <div class="row g-2">
                            <div class="col-6">
                                <button id="skipRepsBtn" class="btn btn-outline-secondary w-100">
                                    <i class="bi bi-skip-forward"></i> è·³è¿‡
                                </button>
                            </div>
                            <div class="col-6">
                                <button id="stopRepsBtn" class="btn btn-outline-danger w-100">
                                    <i class="bi bi-stop-fill"></i> ç»“æŸ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å»º/ç¼–è¾‘è®¡åˆ’å¼¹çª— -->
    <div class="modal fade" id="planModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="planModalTitle">æ–°å»ºè®­ç»ƒè®¡åˆ’</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="planForm">
                        <div class="mb-3">
                            <label for="planName" class="form-label">è®¡åˆ’åç§°</label>
                            <input type="text" class="form-control" id="planName" required placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€é˜¶æ®µ">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="savePlanBtn">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘è®­ç»ƒé¡¹å¼¹çª— -->
    <div class="modal fade" id="exerciseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exerciseModalTitle">æ·»åŠ è®­ç»ƒé¡¹</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="exerciseForm">
                        <div class="mb-3">
                            <label for="exerciseName" class="form-label">è®­ç»ƒé¡¹åç§°</label>
                            <input type="text" class="form-control" id="exerciseNameInput" required placeholder="ä¾‹å¦‚ï¼šå¹³æ¿æ”¯æ’‘">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">è®­ç»ƒç±»å‹</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="exerciseType" id="typeDuration" value="duration" checked>
                                <label class="btn btn-outline-primary" for="typeDuration">æŒç»­æ—¶é—´å‹</label>
                                
                                <input type="radio" class="btn-check" name="exerciseType" id="typeReps" value="reps">
                                <label class="btn btn-outline-primary" for="typeReps">æ¬¡æ•°å‹</label>
                            </div>
                        </div>

                        <!-- æŒç»­æ—¶é—´å‹é…ç½® -->
                        <div id="durationConfig">
                            <div class="mb-3">
                                <label for="duration" class="form-label">åšæŒæ—¶é—´ï¼ˆç§’ï¼‰</label>
                                <input type="number" class="form-control" id="duration" min="1" value="30">
                            </div>
                        </div>

                        <!-- æ¬¡æ•°å‹é…ç½® -->
                        <div id="repsConfig" style="display: none;">
                            <div class="mb-3">
                                <label for="reps" class="form-label">æ¯ç»„æ¬¡æ•°</label>
                                <input type="number" class="form-control" id="reps" min="1" value="10">
                            </div>
                        </div>

                        <!-- å…±åŒé…ç½® -->
                        <div class="mb-3">
                            <label for="sets" class="form-label">ç»„æ•°</label>
                            <input type="number" class="form-control" id="sets" min="1" value="3">
                        </div>

                        <div class="mb-3">
                            <label for="setRest" class="form-label">ç»„é—´ä¼‘æ¯ï¼ˆç§’ï¼‰</label>
                            <input type="number" class="form-control" id="setRest" min="0" value="60">
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">åŠ¨ä½œè¯´æ˜</label>
                            <textarea class="form-control" id="description" rows="3" placeholder="æè¿°åŠ¨ä½œè¦é¢†"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="saveExerciseBtn">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¡®è®¤åˆ é™¤å¼¹çª— -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ç¡®è®¤åˆ é™¤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteMessage">ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿ</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">ç¡®å®šåˆ é™¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è°ƒè¯•é¢æ¿ -->
    <div id="debugPanel" style="display: none; position: fixed; top: 10px; left: 10px; right: 10px; bottom: 10px; background: rgba(0,0,0,0.95); color: white; padding: 15px; border-radius: 8px; z-index: 10000; font-size: 12px; font-family: monospace; overflow: hidden; display: flex; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-shrink: 0;">
            <h6 style="margin: 0; color: #ffc107;">ğŸ” è°ƒè¯•é¢æ¿</h6>
            <button id="closeDebugBtn" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; min-height: 44px; touch-action: manipulation;">å…³é—­</button>
        </div>
        <div id="debugContent" style="flex: 1; overflow-y: auto; margin-bottom: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 4px;"></div>
        <div style="display: flex; gap: 10px; flex-shrink: 0;">
            <button id="testBtn" style="background: #28a745; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; min-height: 44px; touch-action: manipulation; flex: 1;">æµ‹è¯•æŒ‰é’®</button>
            <button id="clearDebugBtn" style="background: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; min-height: 44px; touch-action: manipulation; flex: 1;">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <!-- è°ƒè¯•æŒ‰é’®ï¼ˆç‚¹å‡»3æ¬¡æ˜¾ç¤ºè°ƒè¯•é¢æ¿ï¼‰ -->
    <div id="debugTrigger" style="position: fixed; bottom: 70px; left: 10px; width: 50px; height: 50px; background: rgba(0,0,0,0.7); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; z-index: 9999; cursor: pointer; user-select: none; touch-action: manipulation; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
        ğŸ›
    </div>

    <!-- æœ€åŸºç¡€çš„é”™è¯¯æ˜¾ç¤ºåŒºåŸŸï¼ˆä¸ä¾èµ–JavaScriptï¼‰ -->
    <div id="basicErrorDisplay" style="position: fixed; top: 0; left: 0; right: 0; background: #dc3545; color: white; padding: 15px; z-index: 99999; display: none; font-size: 14px; line-height: 1.5;">
        <div style="font-weight: bold; margin-bottom: 5px;">âš ï¸ JavaScriptåŠ è½½é”™è¯¯</div>
        <div id="basicErrorContent"></div>
    </div>

    <script>
        // ç«‹å³æ‰§è¡Œçš„è°ƒè¯•ä»£ç ï¼ˆä¸ç­‰å¾…ä»»ä½•äº‹ä»¶ï¼‰
        (function() {
            try {
                // åˆ›å»ºé”™è¯¯æ˜¾ç¤ºå‡½æ•°ï¼ˆç«‹å³å¯ç”¨ï¼‰
                window.showBasicError = function(message) {
                    var errorDiv = document.getElementById('basicErrorDisplay');
                    var errorContent = document.getElementById('basicErrorContent');
                    if (errorDiv && errorContent) {
                        errorContent.textContent = message;
                        errorDiv.style.display = 'block';
                    }
                    // åŒæ—¶å°è¯•consoleè¾“å‡º
                    try {
                        console.error('[åŸºç¡€é”™è¯¯]', message);
                    } catch(e) {}
                };

                // ç«‹å³æ˜¾ç¤ºé¡µé¢å·²åŠ è½½
                window.showBasicError('é¡µé¢HTMLå·²åŠ è½½ï¼Œæ­£åœ¨åŠ è½½JavaScript...');
                
                // è®°å½•å¼€å§‹æ—¶é—´
                window.pageLoadStart = Date.now();
                
            } catch(e) {
                // å¦‚æœè¿è¿™ä¸ªéƒ½æ‰§è¡Œä¸äº†ï¼Œè¯´æ˜æœ‰ä¸¥é‡é—®é¢˜
                alert('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + (e.message || 'æœªçŸ¥é”™è¯¯'));
            }
        })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // æ£€æµ‹Bootstrapæ˜¯å¦åŠ è½½
        (function() {
            try {
                if (typeof bootstrap === 'undefined') {
                    window.showBasicError && window.showBasicError('BootstrapæœªåŠ è½½ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼‰');
                } else {
                    console.log('[è°ƒè¯•] BootstrapåŠ è½½æˆåŠŸ');
                }
            } catch(e) {
                window.showBasicError && window.showBasicError('BootstrapåŠ è½½æ£€æµ‹å¤±è´¥: ' + e.message);
            }
        })();

        // è°ƒè¯•å·¥å…·
        window.debugLog = [];
        window.addDebugLog = function(type, message, data) {
            try {
                const log = {
                    time: new Date().toLocaleTimeString(),
                    type: type, // 'info', 'error', 'success', 'warning'
                    message: message,
                    data: data
                };
                window.debugLog.push(log);
                console.log(`[${log.time}] [${type.toUpperCase()}] ${message}`, data || '');
                updateDebugPanel();
            } catch(e) {
                // å¦‚æœè°ƒè¯•å·¥å…·æœ¬èº«å‡ºé”™ï¼Œè‡³å°‘æ˜¾ç¤ºåŸºç¡€é”™è¯¯
                window.showBasicError && window.showBasicError('è°ƒè¯•å·¥å…·é”™è¯¯: ' + e.message);
            }
        };

        function updateDebugPanel() {
            const panel = document.getElementById('debugContent');
            if (!panel) return;
            
            const logs = window.debugLog.slice(-50); // åªæ˜¾ç¤ºæœ€è¿‘50æ¡
            panel.innerHTML = logs.map(log => {
                const color = {
                    'info': '#17a2b8',
                    'error': '#dc3545',
                    'success': '#28a745',
                    'warning': '#ffc107'
                }[log.type] || '#6c757d';
                return `<div style="color: ${color}; margin-bottom: 5px;">
                    <strong>[${log.time}]</strong> ${log.message}
                    ${log.data ? '<br><span style="color: #999; font-size: 10px;">' + JSON.stringify(log.data, null, 2) + '</span>' : ''}
                </div>`;
            }).join('');
            panel.scrollTop = panel.scrollHeight;
        }

        // åˆå§‹åŒ–è°ƒè¯•é¢æ¿
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æµ‹Bootstrapæ˜¯å¦åŠ è½½æˆåŠŸ
            window.addEventListener('load', function() {
                if (typeof bootstrap === 'undefined') {
                    window.addDebugLog('error', 'BootstrapæœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#dc3545;color:white;padding:10px;text-align:center;z-index:99999;';
                    errorDiv.textContent = 'âš ï¸ Bootstrapèµ„æºåŠ è½½å¤±è´¥ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ä½¿ç”¨åœ¨çº¿ç¯å¢ƒã€‚';
                    document.body.insertBefore(errorDiv, document.body.firstChild);
                } else {
                    window.addDebugLog('success', 'BootstrapåŠ è½½æˆåŠŸ');
                }
            });

            // è°ƒè¯•é¢æ¿æ§åˆ¶
            const debugTrigger = document.getElementById('debugTrigger');
            const debugPanel = document.getElementById('debugPanel');
            const closeDebugBtn = document.getElementById('closeDebugBtn');
            const testBtn = document.getElementById('testBtn');
            const clearDebugBtn = document.getElementById('clearDebugBtn');

            // ç‚¹å‡»3æ¬¡æ˜¾ç¤ºè°ƒè¯•é¢æ¿
            let clickCount = 0;
            let clickTimer = null;

            function handleDebugTrigger() {
                clickCount++;
                window.addDebugLog && window.addDebugLog('info', `è°ƒè¯•æŒ‰é’®è¢«ç‚¹å‡» (${clickCount}/3)`);
                
                if (clickTimer) {
                    clearTimeout(clickTimer);
                }
                
                clickTimer = setTimeout(function() {
                    clickCount = 0;
                }, 2000);
                
                if (clickCount >= 3) {
                    debugPanel.style.display = 'flex';
                    window.addDebugLog && window.addDebugLog('success', 'è°ƒè¯•é¢æ¿å·²æ‰“å¼€');
                    clickCount = 0;
                }
            }

            debugTrigger.addEventListener('touchstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                handleDebugTrigger();
            }, { passive: false });

            debugTrigger.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                handleDebugTrigger();
            });

            // ä¸ºè°ƒè¯•é¢æ¿æŒ‰é’®æ·»åŠ è§¦æ‘¸äº‹ä»¶
            function addDebugButtonEvents(btn, handler) {
                btn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    handler();
                }, { passive: false });
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    handler();
                });
            }

            addDebugButtonEvents(closeDebugBtn, function() {
                debugPanel.style.display = 'none';
                window.addDebugLog && window.addDebugLog('info', 'è°ƒè¯•é¢æ¿å·²å…³é—­');
            });

            addDebugButtonEvents(testBtn, function() {
                window.addDebugLog && window.addDebugLog('info', 'æµ‹è¯•æŒ‰é’®è¢«ç‚¹å‡»');
                testAllButtons();
            });

            addDebugButtonEvents(clearDebugBtn, function() {
                window.debugLog = [];
                updateDebugPanel();
                window.addDebugLog && window.addDebugLog('info', 'æ—¥å¿—å·²æ¸…ç©º');
            });

            // æµ‹è¯•æ‰€æœ‰æŒ‰é’®
            function testAllButtons() {
                const buttons = [
                    'newPlanBtn', 'exportBtn', 'importBtn', 'addExerciseBtn', 
                    'startTrainingBtn', 'savePlanBtn', 'saveExerciseBtn'
                ];
                
                buttons.forEach(btnId => {
                    const btn = document.getElementById(btnId);
                    if (btn) {
                        window.addDebugLog('success', `æŒ‰é’® ${btnId} å­˜åœ¨`, {
                            text: btn.textContent.trim(),
                            disabled: btn.disabled
                        });
                    } else {
                        window.addDebugLog('error', `æŒ‰é’® ${btnId} ä¸å­˜åœ¨`);
                    }
                });
            }

            // æ”¶é›†è®¾å¤‡ä¿¡æ¯
            window.addDebugLog('info', 'è®¾å¤‡ä¿¡æ¯', {
                userAgent: navigator.userAgent,
                isMobile: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
                platform: navigator.platform,
                language: navigator.language,
                screen: {
                    width: window.screen.width,
                    height: window.screen.height
                },
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight
                }
            });
            
            // æ·»åŠ è·¯å¾„è¯Šæ–­ä¿¡æ¯åˆ°è°ƒè¯•é¢æ¿
            window.addDebugLog('info', 'è·¯å¾„è¯Šæ–­', {
                'å½“å‰é¡µé¢URL': window.location.href,
                'åŸºç¡€è·¯å¾„': window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1),
                'åè®®': window.location.protocol,
                'ä¸»æœº': window.location.host || 'æœ¬åœ°æ–‡ä»¶',
                'é¢„æœŸJSè·¯å¾„': 'js/storage.js, js/audio.js, js/timer.js, js/main.js'
            });
            
            // æµ‹è¯•æ‰€æœ‰JSæ–‡ä»¶è·¯å¾„
            setTimeout(function() {
                var jsFiles = ['js/storage.js', 'js/audio.js', 'js/timer.js', 'js/main.js'];
                jsFiles.forEach(function(filePath) {
                    window.testFileExists(filePath).then(function(exists) {
                        window.addDebugLog(exists ? 'success' : 'error', 
                            'æ–‡ä»¶è·¯å¾„æ£€æµ‹: ' + filePath, 
                            { exists: exists, fullPath: window.location.href.replace(/[^/]*$/, '') + filePath }
                        );
                    });
                });
            }, 1000);
        });
    </script>
    <script>
        // è·¯å¾„æ£€æµ‹å’Œè¯Šæ–­å·¥å…·
        window.pathDiagnostics = {
            currentPath: window.location.href,
            basePath: window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1),
            protocol: window.location.protocol,
            host: window.location.host
        };
        
        // æ˜¾ç¤ºè·¯å¾„ä¿¡æ¯
        console.log('[è·¯å¾„è¯Šæ–­]', {
            'å½“å‰é¡µé¢URL': window.pathDiagnostics.currentPath,
            'åŸºç¡€è·¯å¾„': window.pathDiagnostics.basePath,
            'åè®®': window.pathDiagnostics.protocol,
            'ä¸»æœº': window.pathDiagnostics.host || 'æœ¬åœ°æ–‡ä»¶'
        });
        
        // æ£€æµ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        window.testFileExists = function(filePath) {
            return new Promise(function(resolve) {
                var xhr = new XMLHttpRequest();
                xhr.open('HEAD', filePath, true);
                xhr.onload = function() {
                    resolve(xhr.status === 200 || xhr.status === 0); // 0è¡¨ç¤ºfile://åè®®
                };
                xhr.onerror = function() {
                    resolve(false);
                };
                xhr.send();
            });
        };
        
        // åœ¨æ¯ä¸ªJSæ–‡ä»¶åŠ è½½å‰åéƒ½æ·»åŠ æ£€æµ‹
        window.jsFilesStatus = {};
        window.checkJSFile = function(filename, status) {
            window.jsFilesStatus[filename] = status;
            var filePath = 'js/' + filename;
            var msg = filename + (status ? ' åŠ è½½æˆåŠŸ' : ' åŠ è½½å¤±è´¥');
            console.log('[æ–‡ä»¶æ£€æµ‹]', msg, 'è·¯å¾„: ' + filePath);
            window.addDebugLog && window.addDebugLog(status ? 'success' : 'error', msg, {
                path: filePath,
                fullPath: window.pathDiagnostics.basePath + filePath
            });
            
            if (!status) {
                // æµ‹è¯•æ–‡ä»¶æ˜¯å¦å­˜åœ¨
                window.testFileExists(filePath).then(function(exists) {
                    var errorMsg = 'æ–‡ä»¶åŠ è½½å¤±è´¥: ' + filename + '\n';
                    errorMsg += 'å°è¯•è·¯å¾„: ' + filePath + '\n';
                    errorMsg += 'å®Œæ•´è·¯å¾„: ' + window.pathDiagnostics.basePath + filePath + '\n';
                    errorMsg += 'æ–‡ä»¶å­˜åœ¨: ' + (exists ? 'æ˜¯' : 'å¦') + '\n';
                    errorMsg += 'å½“å‰åè®®: ' + window.pathDiagnostics.protocol + '\n\n';
                    
                    if (!exists) {
                        errorMsg += 'å¯èƒ½åŸå› ï¼š\n';
                        errorMsg += '1. æ–‡ä»¶è·¯å¾„ä¸æ­£ç¡®\n';
                        errorMsg += '2. æ–‡ä»¶ä¸å­˜åœ¨\n';
                        errorMsg += '3. æ–‡ä»¶æƒé™é—®é¢˜\n';
                        if (window.pathDiagnostics.protocol === 'file:') {
                            errorMsg += '\næç¤ºï¼šä½¿ç”¨file://åè®®æ—¶ï¼Œç¡®ä¿æ‰€æœ‰æ–‡ä»¶åœ¨åŒä¸€æ–‡ä»¶å¤¹ä¸‹';
                        }
                    } else {
                        errorMsg += 'æ–‡ä»¶å­˜åœ¨ä½†æ— æ³•åŠ è½½ï¼Œå¯èƒ½æ˜¯ï¼š\n';
                        errorMsg += '1. JavaScriptè¯­æ³•é”™è¯¯\n';
                        errorMsg += '2. æ–‡ä»¶ç¼–ç é—®é¢˜\n';
                        errorMsg += '3. æµè§ˆå™¨å®‰å…¨é™åˆ¶';
                    }
                    
                    window.showBasicError && window.showBasicError(errorMsg);
                });
            }
        };
        
        // æ˜¾ç¤ºè·¯å¾„è¯Šæ–­ä¿¡æ¯
        window.addDebugLog && window.addDebugLog('info', 'è·¯å¾„è¯Šæ–­ä¿¡æ¯', window.pathDiagnostics);
    </script>
    
    <script>
        // è·¯å¾„ä¿®å¤ï¼šè·å–æ­£ç¡®çš„JSæ–‡ä»¶è·¯å¾„
        (function() {
            function getCorrectJSPath(filename) {
                // è·å–å½“å‰HTMLæ–‡ä»¶çš„ç›®å½•
                var htmlPath = window.location.href;
                var htmlDir = htmlPath.substring(0, htmlPath.lastIndexOf('/') + 1);
                
                // æ„å»ºJSæ–‡ä»¶è·¯å¾„
                var jsPath = htmlDir + 'js/' + filename;
                
                console.log('[è·¯å¾„ä¿®å¤] HTMLç›®å½•:', htmlDir);
                console.log('[è·¯å¾„ä¿®å¤] JSæ–‡ä»¶è·¯å¾„:', jsPath);
                
                return jsPath;
            }
            
            // åŠ¨æ€åŠ è½½JSæ–‡ä»¶
            function loadScript(filename, callback) {
                var script = document.createElement('script');
                script.type = 'text/javascript';
                
                // ä½¿ç”¨ç»å¯¹è·¯å¾„
                var jsPath = getCorrectJSPath(filename);
                script.src = jsPath;
                
                script.onload = function() {
                    console.log('[æˆåŠŸ] åŠ è½½:', filename, 'ä»è·¯å¾„:', jsPath);
                    window.checkJSFile && window.checkJSFile(filename, true);
                    callback && callback(true);
                };
                
                script.onerror = function() {
                    console.error('[å¤±è´¥] æ— æ³•åŠ è½½:', filename, 'è·¯å¾„:', jsPath);
                    window.checkJSFile && window.checkJSFile(filename, false);
                    
                    // å°è¯•ç›¸å¯¹è·¯å¾„ä½œä¸ºå¤‡ç”¨
                    var fallbackPath = 'js/' + filename;
                    console.log('[å¤‡ç”¨] å°è¯•ç›¸å¯¹è·¯å¾„:', fallbackPath);
                    
                    var fallbackScript = document.createElement('script');
                    fallbackScript.type = 'text/javascript';
                    fallbackScript.src = fallbackPath;
                    fallbackScript.onload = function() {
                        console.log('[æˆåŠŸ] å¤‡ç”¨è·¯å¾„åŠ è½½æˆåŠŸ:', filename);
                        window.checkJSFile && window.checkJSFile(filename, true);
                        callback && callback(true);
                    };
                    fallbackScript.onerror = function() {
                        console.error('[å¤±è´¥] å¤‡ç”¨è·¯å¾„ä¹Ÿå¤±è´¥:', filename);
                        callback && callback(false);
                    };
                    document.head.appendChild(fallbackScript);
                };
                
                document.head.appendChild(script);
            }
            
            // ä¾æ¬¡åŠ è½½æ‰€æœ‰JSæ–‡ä»¶
            var jsFiles = ['storage.js', 'audio.js', 'timer.js', 'main.js'];
            var loadedCount = 0;
            
            function loadNext(index) {
                if (index >= jsFiles.length) {
                    // æ‰€æœ‰æ–‡ä»¶åŠ è½½å®Œæˆï¼Œæ£€æŸ¥æ˜¯å¦éƒ½æˆåŠŸ
                    setTimeout(function() {
                        var allLoaded = true;
                        var failedFiles = [];
                        
                        if (typeof StorageManager === 'undefined') {
                            allLoaded = false;
                            failedFiles.push('storage.js');
                        }
                        if (typeof VoiceManager === 'undefined') {
                            allLoaded = false;
                            failedFiles.push('audio.js');
                        }
                        if (typeof TrainingTimer === 'undefined') {
                            allLoaded = false;
                            failedFiles.push('timer.js');
                        }
                        if (typeof RehabTrainerApp === 'undefined') {
                            allLoaded = false;
                            failedFiles.push('main.js');
                        }
                        
                        if (!allLoaded) {
                            var errorMsg = 'ä»¥ä¸‹JavaScriptæ–‡ä»¶åŠ è½½å¤±è´¥ï¼š\n' + failedFiles.join('\n') + 
                                         '\n\nå½“å‰é¡µé¢è·¯å¾„ï¼š' + window.location.href +
                                         '\n\nè¯·ç¡®ä¿ï¼š\n1. HTMLæ–‡ä»¶å’Œjsæ–‡ä»¶å¤¹åœ¨åŒä¸€ç›®å½•ä¸‹\n2. jsæ–‡ä»¶å¤¹ä¸‹æœ‰æ‰€æœ‰.jsæ–‡ä»¶\n3. æ–‡ä»¶ç»“æ„æ­£ç¡®';
                            window.showBasicError && window.showBasicError(errorMsg);
                            console.error('[ä¸¥é‡é”™è¯¯]', errorMsg);
                        } else {
                            console.log('[æˆåŠŸ] æ‰€æœ‰JavaScriptæ–‡ä»¶åŠ è½½æˆåŠŸ');
                            var errorDiv = document.getElementById('basicErrorDisplay');
                            if (errorDiv) {
                                errorDiv.style.display = 'none';
                            }
                        }
                    }, 500);
                    return;
                }
                
                loadScript(jsFiles[index], function(success) {
                    loadedCount++;
                    // å»¶è¿ŸåŠ è½½ä¸‹ä¸€ä¸ªï¼Œé¿å…å¹¶å‘é—®é¢˜
                    setTimeout(function() {
                        loadNext(index + 1);
                    }, 50);
                });
            }
            
            // å¼€å§‹åŠ è½½
            loadNext(0);
        })();
    </script>
    
    <script>
        // æœ€ç»ˆæ£€æµ‹ï¼šæ‰€æœ‰æ–‡ä»¶åŠ è½½å®Œæˆå
        setTimeout(function() {
            var allLoaded = true;
            var failedFiles = [];
            
            if (typeof StorageManager === 'undefined') {
                allLoaded = false;
                failedFiles.push('storage.js');
            }
            if (typeof VoiceManager === 'undefined') {
                allLoaded = false;
                failedFiles.push('audio.js');
            }
            if (typeof TrainingTimer === 'undefined') {
                allLoaded = false;
                failedFiles.push('timer.js');
            }
            if (typeof RehabTrainerApp === 'undefined') {
                allLoaded = false;
                failedFiles.push('main.js');
            }
            
            if (!allLoaded) {
                var errorMsg = 'ä»¥ä¸‹JavaScriptæ–‡ä»¶åŠ è½½å¤±è´¥ï¼š\n' + failedFiles.join('\n') + '\n\nè¯·æ£€æŸ¥ï¼š\n1. æ–‡ä»¶æ˜¯å¦å­˜åœ¨äº js/ æ–‡ä»¶å¤¹ä¸‹\n2. æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®\n3. æ–‡ä»¶æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯';
                window.showBasicError && window.showBasicError(errorMsg);
                console.error('[ä¸¥é‡é”™è¯¯]', errorMsg);
            } else {
                console.log('[è°ƒè¯•] æ‰€æœ‰JavaScriptæ–‡ä»¶åŠ è½½æˆåŠŸ');
                // éšè—åŸºç¡€é”™è¯¯æç¤º
                var errorDiv = document.getElementById('basicErrorDisplay');
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                }
            }
        }, 500);
    </script>
</body>
</html>
